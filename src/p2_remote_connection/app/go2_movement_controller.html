<!-- go2_movement_controller.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Go2 Movement Controller</title>

  <link rel="stylesheet" href="./shared.css" />
  <script src="./shared.js"></script>
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="loginOverlay">
    <div class="loginCard">
      <h2>Connect to Go2</h2>
      <div class="loginForm">
        <input id="loginBaseUrl" placeholder="http://robot-ip:8000 or https://robot.domain"
               value="https://p2dingo-control-backend.p2agentx.com" />
        <input id="loginToken" placeholder="Password" type="password" />
        <button id="unlockBtn" onclick="Go2Shared.login()">Unlock</button>
        <div id="loginMsg" class="loginMsg"></div>
        <div class="loginTip">Tip: This password is unique per robot.</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appRoot" class="appLocked">
    <div class="card">
      <h1>Unitree Go2 â€“ Movement Controller</h1>

      <div class="row">
        <input id="baseUrl" placeholder="http://<go2-ip>:8000" />
        <button onclick="Go2Shared.checkHealth()">Health</button>

        <button id="modeMovement" onclick="setMode('movement')">Mode: Movement</button>
        <button id="modePosing"   onclick="setMode('posing')">Mode: Posing</button>
        <button id="modeActions"  onclick="setMode('actions')">Mode: Actions</button>

        <span id="modePill" class="pill">mode: movement</span>

        <button id="safetyToggleBtn" class="danger" onclick="toggleSafety()">STOP</button>
        <button onclick="Go2Shared.logout()">Logout</button>
      </div>

      <div class="small" style="margin-top:8px;">
        UI host: <span id="uiHost" class="mono"></span><br/>
        API base: <span id="apiHost" class="mono"></span>
      </div>

      <!-- Movement -->
      <div id="panelMovement" class="panel">
        <h2>Movement mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('economic_gait')">EconomicGait</button>
          <button onclick="postAction('trot_run')">TrotRun</button>
          <button onclick="postAction('switch_avoid')">SwitchAvoidMode</button>
          <button onclick="postAction('cycle_speed')">SpeedLevel (cycle)</button>

          <button data-action="toggle_freebound" data-label="FreeBound" onclick="setToggleExclusive('toggle_freebound')">FreeBound</button>
          <button data-action="toggle_freeavoid" data-label="FreeAvoid" onclick="setToggleExclusive('toggle_freeavoid')">FreeAvoid</button>
          <button data-action="toggle_crossstep" data-label="CrossStep" onclick="setToggleExclusive('toggle_crossstep')">CrossStep</button>
          <button data-action="toggle_freejump" data-label="FreeJump" onclick="setToggleExclusive('toggle_freejump')">FreeJump</button>
          <button data-action="toggle_walkupright" data-label="WalkUpright" onclick="setToggleExclusive('toggle_walkupright')">WalkUpright</button>
          <button data-action="toggle_handstand" data-label="HandStand" onclick="setToggleExclusive('toggle_handstand')">HandStand</button>

          <button onclick="postAction('stop_move')">StopMove</button>
          <button onclick="postAction('static_walk')">StaticWalk</button>
        </div>
      </div>

      <!-- Posing -->
      <div id="panelPosing" class="panel" style="display:none;">
        <h2>Posing mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('damp')">Damp</button>
          <button onclick="postAction('balance_stand')">BalanceStand</button>
        </div>
      </div>

      <!-- Actions -->
      <div id="panelActions" class="panel" style="display:none;">
        <h2>Actions mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('sit_toggle')">Sit â†” Stand (toggle)</button>
          <button onclick="postAction('hello')">Hello</button>
          <button onclick="postAction('stretch')">Stretch</button>
          <button onclick="postAction('content')">Content</button>
          <button onclick="postAction('heart')">Heart</button>
          <button onclick="postAction('scrape')">Scrape</button>
          <button onclick="postAction('front_jump')">FrontJump</button>
          <button onclick="postAction('front_pounce')">FrontPounce</button>
          <button onclick="postAction('front_flip')">FrontFlip</button>
          <button onclick="postAction('back_flip')">BackFlip</button>
          <button onclick="postAction('recovery')">RecoveryStand</button>
        </div>
      </div>

      <div class="status">
        <div id="msg" class="small">Ready.</div>
        <div id="detail" class="mono"></div>
      </div>

      <div class="small" style="margin-top:10px;">
        STOP latches the system: no actions until RESUME.
      </div>
    </div>
  </div>

<script>
  // ---- init shared ----
  window.addEventListener("DOMContentLoaded", () => {
    Go2Shared.init({ defaultApi: "https://p2dingo-control-backend.p2agentx.com" });
    updateModeUI();
    // if remembered login succeeds, you likely want to sync safety state:
    setTimeout(refreshSafetyStatus, 200);
  });

  // ----------------------------
  // Safety STOP/RESUME latch
  // ----------------------------
  let stopLatched = false;
  let safetyBusy = false;

  function setSafetyButton(latched) {
    stopLatched = !!latched;
    const btn = document.getElementById("safetyToggleBtn");
    btn.textContent = stopLatched ? "RESUME" : "STOP";
    btn.classList.toggle("danger", !stopLatched);
    btn.disabled = safetyBusy;
  }

  async function refreshSafetyStatus() {
    if (!Go2Shared.ensureLoggedIn()) return;
    const r = await Go2Shared.httpGet("/safety/status", { bypassCommsGate: true });
    if (r.ok) {
      try { setSafetyButton(JSON.parse(r.text).stop_latched); } catch {}
    }
    return r;
  }

  async function toggleSafety() {
    if (!Go2Shared.ensureLoggedIn() || safetyBusy) return;
    safetyBusy = true;
    setSafetyButton(stopLatched);

    try {
      if (!stopLatched) {
        const r = await Go2Shared.httpPost("/safety/stop", null, { bypassCommsGate: true });
        if (!r.ok) { Go2Shared.setStatus(`STOP failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        Go2Shared.state.COMMS_ENABLED = false;
        Go2Shared.setStatus("STOP latched ðŸ”’", true, `URL: ${r.url}\n${r.text}`);
      } else {
        const r = await Go2Shared.httpPost("/safety/resume", null, { bypassCommsGate: true });
        if (!r.ok) { Go2Shared.setStatus(`RESUME failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        Go2Shared.state.COMMS_ENABLED = true;
        Go2Shared.setStatus("RESUME âœ…", true, `URL: ${r.url}\n${r.text}`);
      }
    } finally {
      safetyBusy = false;
      await refreshSafetyStatus();
    }
  }

  // ----------------------------
  // Mode + Action buttons
  // ----------------------------
  let currentMode = "movement";

  function updateModeUI() {
    document.getElementById("modePill").textContent = `mode: ${currentMode}`;

    document.getElementById("modeMovement").classList.toggle("activeMode", currentMode==="movement");
    document.getElementById("modePosing").classList.toggle("activeMode", currentMode==="posing");
    document.getElementById("modeActions").classList.toggle("activeMode", currentMode==="actions");

    document.getElementById("panelMovement").style.display = (currentMode==="movement") ? "block" : "none";
    document.getElementById("panelPosing").style.display   = (currentMode==="posing") ? "block" : "none";
    document.getElementById("panelActions").style.display  = (currentMode==="actions") ? "block" : "none";
  }

  async function setMode(m) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) { Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands."); return; }

    const map = { movement: "mode_movement", posing: "mode_posing", actions: "mode_actions" };
    const action = map[m];
    const r = await Go2Shared.httpPost(`/actions/${action}`);
    if (!r.ok) {
      Go2Shared.setStatus(`Mode set failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`);
      return;
    }
    currentMode = m;
    updateModeUI();
    Go2Shared.setStatus(`Mode: ${m} âœ…`, true);
  }

  async function postAction(action) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) { Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands."); return; }

    const r = await Go2Shared.httpPost(`/actions/${action}`);
    Go2Shared.setStatus(r.ok ? `${action} âœ…` : `${action} failed (HTTP ${r.status})`, r.ok, `URL: ${r.url}\n${r.text}`);
  }

  // ----------------------------
  // Exclusive toggles
  // ----------------------------
  const TOGGLES = [
    "toggle_freebound",
    "toggle_freeavoid",
    "toggle_crossstep",
    "toggle_freejump",
    "toggle_walkupright",
    "toggle_handstand",
  ];
  const toggleState = Object.fromEntries(TOGGLES.map(a => [a, false]));

  function setToggleBtn(action, on) {
    const btn = document.querySelector(`[data-action="${action}"]`);
    if (!btn) return;
    const label = btn.getAttribute("data-label");
    btn.textContent = label + (on ? " âœ…" : "");
    btn.classList.toggle("toggleOn", !!on);
  }

  function setAllToggleButtonsEnabled(enabled) {
    for (const a of TOGGLES) {
      const btn = document.querySelector(`[data-action="${a}"]`);
      if (btn) btn.disabled = !enabled;
    }
  }

  async function setToggleExclusive(target) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) {
      Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands.");
      return;
    }

    if (toggleState[target]) {
      setAllToggleButtonsEnabled(false);
      try {
        const r = await Go2Shared.httpPost(`/actions/${target}`);
        if (!r.ok) { Go2Shared.setStatus(`${target} failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        toggleState[target] = false;
        setToggleBtn(target, false);
        Go2Shared.setStatus(`${target.replace("toggle_", "")} DISABLED âœ…`, true);
      } finally {
        setAllToggleButtonsEnabled(true);
      }
      return;
    }

    setAllToggleButtonsEnabled(false);
    try {
      for (const a of TOGGLES) {
        if (a !== target && toggleState[a]) {
          const rOff = await Go2Shared.httpPost(`/actions/${a}`);
          if (!rOff.ok) { Go2Shared.setStatus(`Failed disabling ${a} (HTTP ${rOff.status})`, false, `URL: ${rOff.url}\n${rOff.text}`); return; }
          toggleState[a] = false;
          setToggleBtn(a, false);
        }
      }

      const rOn = await Go2Shared.httpPost(`/actions/${target}`);
      if (!rOn.ok) { Go2Shared.setStatus(`${target} failed (HTTP ${rOn.status})`, false, `URL: ${rOn.url}\n${rOn.text}`); return; }
      toggleState[target] = true;
      setToggleBtn(target, true);
      Go2Shared.setStatus(`${target.replace("toggle_", "")} ENABLED âœ…`, true);
    } finally {
      setAllToggleButtonsEnabled(true);
    }
  }
</script>
</body>
</html>
