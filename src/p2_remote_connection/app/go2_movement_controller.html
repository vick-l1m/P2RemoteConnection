<!-- go2_movement_controller.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Go2 Movement Controller</title>

  <link rel="stylesheet" href="/app/static/shared.css" />
  <script src="/app/static/shared.js"></script>
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="loginOverlay">
    <div class="loginCard">
      <h2>Connect to Go2</h2>
      <div class="loginForm">
        <input id="loginBaseUrl" placeholder="http://robot-ip:8000 or https://robot.domain"/>
        <input id="loginToken" placeholder="Password" type="password" />
        <button id="unlockBtn" onclick="Go2Shared.login()">Unlock</button>
        <div id="loginMsg" class="loginMsg"></div>
        <div class="loginTip">Tip: This password is unique per robot.</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appRoot">
    <div class="card">
      <h1>Unitree Go2 â€“ Movement Controller</h1>

      <div class="row">
        <input id="baseUrl" placeholder="http://<go2-ip>:8000" />
        <button onclick="Go2Shared.checkHealth()">Health</button>

        <button id="modeMovement" onclick="setMode('movement')">Mode: Movement</button>
        <button id="modePosing"   onclick="setMode('posing')">Mode: Posing</button>
        <button id="modeActions"  onclick="setMode('actions')">Mode: Actions</button>

        <span id="modePill" class="pill">mode: movement</span>

        <button id="safetyToggleBtn" class="danger" onclick="toggleSafety()">STOP</button>
        <button onclick="Go2Shared.logout()">Logout</button>
      </div>

      <div class="small" style="margin-top:8px;">
        UI host: <span id="uiHost" class="mono"></span><br/>
        API base: <span id="apiHost" class="mono"></span>
      </div>
      
      <!-- Joysticks -->
      <div class="grid2">
        <div class="joyBox">
          <div class="joyTitle">Left joystick: X=strife, Y=fwd/back</div>
          <canvas id="joyLeft"></canvas>
        </div>
        <div class="joyBox">
          <div class="joyTitle">Right joystick: X=turn (yaw)</div>
          <canvas id="joyRight"></canvas>
        </div>
      </div>

      <!-- Movement -->
      <div id="panelMovement" class="panel">
        <h2>Movement mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('economic_gait')">EconomicGait</button>
          <button onclick="postAction('trot_run')">TrotRun</button>
          <button onclick="postAction('switch_avoid')">SwitchAvoidMode</button>
          <button onclick="postAction('cycle_speed')">SpeedLevel (cycle)</button>
          <button onclick="postAction('freewalk')">FreeWalk</button>


          <button data-action="toggle_freebound" data-label="FreeBound" onclick="setToggleExclusive('toggle_freebound')">FreeBound</button>
          <button data-action="toggle_freeavoid" data-label="FreeAvoid" onclick="setToggleExclusive('toggle_freeavoid')">FreeAvoid</button>
          <button data-action="toggle_crossstep" data-label="CrossStep" onclick="setToggleExclusive('toggle_crossstep')">CrossStep</button>
          <button data-action="toggle_freejump" data-label="FreeJump" onclick="setToggleExclusive('toggle_freejump')">FreeJump</button>
          <button data-action="toggle_walkupright" data-label="WalkUpright" onclick="setToggleExclusive('toggle_walkupright')">WalkUpright</button>
          <button data-action="toggle_handstand" data-label="HandStand" onclick="setToggleExclusive('toggle_handstand')">HandStand</button>
          <button data-action="toggle_classicwalk" data-label="ClassicWalk" onclick="setToggleExclusive('toggle_classicwalk')">ClassicWalk</button>
          <button onclick="postAction('stop_move')">StopMove</button>
          <button onclick="postAction('static_walk')">StaticWalk</button>
        </div>
      </div>

      <!-- Posing -->
      <div id="panelPosing" class="panel" style="display:none;">
        <h2>Posing mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('damp')">Damp</button>
          <button onclick="postAction('balance_stand')">BalanceStand</button>
        </div>
      </div>

      <!-- Actions -->
      <div id="panelActions" class="panel" style="display:none;">
        <h2>Actions mode commands</h2>
        <div class="btnGrid">
          <button onclick="postAction('sit_toggle')">Sit â†” Stand (toggle)</button>
          <button onclick="postAction('hello')">Hello</button>
          <button onclick="postAction('stretch')">Stretch</button>
          <button onclick="postAction('content')">Content</button>
          <button onclick="postAction('heart')">Heart</button>
          <button onclick="postAction('scrape')">Scrape</button>
          <button onclick="postAction('front_jump')">FrontJump</button>

          <!-- Danger actions -->
          <button onclick="postDangerAction('front_pounce')">FrontPounce</button>
          <button onclick="postDangerAction('front_flip')">FrontFlip</button>
          <button onclick="postDangerAction('back_flip')">BackFlip</button>
          <button onclick="postDangerAction('left_flip')">LeftFlip</button>

          <button onclick="postAction('recovery')">RecoveryStand</button>
        </div>
      </div>

      <!-- DANGER CONFIRM MODAL -->
      <div id="dangerModal" class="modalOverlay" style="display:none;">
        <div class="modalCard">
          <h2 style="margin:0 0 6px;">Are you sure?</h2>
          <div id="dangerModalText" class="small" style="margin-bottom:12px;">
            You are about to run a risky action.
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button id="dangerCancelBtn" onclick="dangerModalCancel()">Cancel</button>
            <button id="dangerConfirmBtn" class="danger" onclick="dangerModalConfirm()">Confirm</button>
          </div>
        </div>
      </div>

      <div class="status">
        <div id="msg" class="small">Ready.</div>
        <div id="detail" class="mono"></div>
      </div>

      <div class="small" style="margin-top:10px;">
        STOP latches the system: no actions until RESUME.
      </div>
    </div>
  </div>

<script>
  // ---- init shared ----
  window.addEventListener("DOMContentLoaded", async () => {
    await Go2Shared.init({ defaultApi: "", showAuthButtons: true });
    updateModeUI();
    setTimeout(refreshSafetyStatus, 200);
  
    // joysticks start after DOM exists
    makeJoystick("joyLeft", (x, y, active) => {
      latest.lx = active ? x : 0;
      latest.ly = active ? y : 0;
    });
    makeJoystick("joyRight", (x, y, active) => {
      latest.rx = active ? x : 0;
    });
  
    window.setInterval(() => {
      if (!Go2Shared.ensureLoggedIn() || !Go2Shared.state.COMMS_ENABLED) return;
      const eps = 0.01;
      if (Math.abs(latest.lx) < eps && Math.abs(latest.ly) < eps && Math.abs(latest.rx) < eps) return;
      sendTeleop(latest.lx, latest.ly, latest.rx);
    }, SEND_PERIOD_MS);
  });

  // ----------------------------
  // Safety STOP/RESUME latch
  // ----------------------------
  let stopLatched = false;
  let safetyBusy = false;

  function setSafetyButton(latched) {
    stopLatched = !!latched;
    const btn = document.getElementById("safetyToggleBtn");
    btn.textContent = stopLatched ? "RESUME" : "STOP";
    btn.classList.toggle("danger", !stopLatched);
    btn.disabled = safetyBusy;
  }

  async function refreshSafetyStatus() {
    if (!Go2Shared.ensureLoggedIn()) return;
    const r = await Go2Shared.httpGet("/safety/status", { bypassCommsGate: true });
    if (r.ok) {
      try { setSafetyButton(JSON.parse(r.text).stop_latched); } catch {}
    }
    return r;
  }

  async function toggleSafety() {
    if (!Go2Shared.ensureLoggedIn() || safetyBusy) return;
    safetyBusy = true;
    setSafetyButton(stopLatched);

    try {
      if (!stopLatched) {
        const r = await Go2Shared.httpPost("/safety/stop", null, { bypassCommsGate: true });
        if (!r.ok) { Go2Shared.setStatus(`STOP failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        Go2Shared.state.COMMS_ENABLED = false;
        Go2Shared.setStatus("STOP latched ðŸ”’", true, `URL: ${r.url}\n${r.text}`);
      } else {
        const r = await Go2Shared.httpPost("/safety/resume", null, { bypassCommsGate: true });
        if (!r.ok) { Go2Shared.setStatus(`RESUME failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        Go2Shared.state.COMMS_ENABLED = true;
        Go2Shared.setStatus("RESUME âœ…", true, `URL: ${r.url}\n${r.text}`);
      }
    } finally {
      safetyBusy = false;
      await refreshSafetyStatus();
    }
  }

  // ----------------------------
  // Mode + Action buttons
  // ----------------------------
  let currentMode = "movement";

  function updateModeUI() {
    document.getElementById("modePill").textContent = `mode: ${currentMode}`;

    document.getElementById("modeMovement").classList.toggle("activeMode", currentMode==="movement");
    document.getElementById("modePosing").classList.toggle("activeMode", currentMode==="posing");
    document.getElementById("modeActions").classList.toggle("activeMode", currentMode==="actions");

    document.getElementById("panelMovement").style.display = (currentMode==="movement") ? "block" : "none";
    document.getElementById("panelPosing").style.display   = (currentMode==="posing") ? "block" : "none";
    document.getElementById("panelActions").style.display  = (currentMode==="actions") ? "block" : "none";
  }

  async function setMode(m) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) { Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands."); return; }

    const map = { movement: "mode_movement", posing: "mode_posing", actions: "mode_actions" };
    const action = map[m];
    const r = await Go2Shared.httpPost(`/actions/${action}`);
    if (!r.ok) {
      Go2Shared.setStatus(`Mode set failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`);
      return;
    }
    currentMode = m;
    updateModeUI();
    Go2Shared.setStatus(`Mode: ${m} âœ…`, true);
  }

  async function postAction(action) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) { Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands."); return; }

    const r = await Go2Shared.httpPost(`/actions/${action}`);
    Go2Shared.setStatus(r.ok ? `${action} âœ…` : `${action} failed (HTTP ${r.status})`, r.ok, `URL: ${r.url}\n${r.text}`);
  }

  // ----------------------------
  // Modal confirmation for risky actions
  // ----------------------------
  const DANGER_ACTIONS = new Set(["front_flip", "back_flip", "left_flip", "front_pounce"]);
  
  const dangerModal = {
    action: null,
    open(action) {
      this.action = action;
      const overlay = document.getElementById("dangerModal");
      const text = document.getElementById("dangerModalText");
  
      // Nice label
      const label = action
        .replaceAll("_", " ")
        .replace(/\b\w/g, c => c.toUpperCase());
  
      text.textContent = `You are about to run: ${label}. This can be unsafe if the area isnâ€™t clear.`;
      overlay.style.display = "flex";
    },
    close() {
      this.action = null;
      document.getElementById("dangerModal").style.display = "none";
    }
  };
  
  async function postDangerAction(action) {
    // Non-danger actions just go through normally
    if (!DANGER_ACTIONS.has(action)) return postAction(action);
  
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) {
      Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands.");
      return;
    }
  
    dangerModal.open(action);
  }
  
  function dangerModalCancel() {
    dangerModal.close();
  }
  
  async function dangerModalConfirm() {
    const action = dangerModal.action;
    dangerModal.close();
    if (!action) return;
  
    // postAction already checks STOP latch and login, but keeping it simple:
    await postAction(action);
  }
  
  // Close modal on clicking the shaded background
  document.addEventListener("click", (e) => {
    const overlay = document.getElementById("dangerModal");
    if (!overlay || overlay.style.display === "none") return;
    if (e.target === overlay) dangerModal.close();
  });
  
  // Close modal with ESC
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") dangerModal.close();
  });

  // ----------------------------
  // Exclusive toggles
  // ----------------------------
  const TOGGLES = [
    "toggle_freebound",
    "toggle_freeavoid",
    "toggle_crossstep",
    "toggle_freejump",
    "toggle_walkupright",
    "toggle_handstand",
    "toggle_classicwalk"
  ];
  const toggleState = Object.fromEntries(TOGGLES.map(a => [a, false]));

  function setToggleBtn(action, on) {
    const btn = document.querySelector(`[data-action="${action}"]`);
    if (!btn) return;
    const label = btn.getAttribute("data-label");
    btn.textContent = label + (on ? " âœ…" : "");
    btn.classList.toggle("toggleOn", !!on);
  }

  function setAllToggleButtonsEnabled(enabled) {
    for (const a of TOGGLES) {
      const btn = document.querySelector(`[data-action="${a}"]`);
      if (btn) btn.disabled = !enabled;
    }
  }

  async function setToggleExclusive(target) {
    if (!Go2Shared.ensureLoggedIn()) return;
    if (!Go2Shared.state.COMMS_ENABLED) {
      Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME to enable commands.");
      return;
    }

    if (toggleState[target]) {
      setAllToggleButtonsEnabled(false);
      try {
        const r = await Go2Shared.httpPost(`/actions/${target}`);
        if (!r.ok) { Go2Shared.setStatus(`${target} failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`); return; }
        toggleState[target] = false;
        setToggleBtn(target, false);
        Go2Shared.setStatus(`${target.replace("toggle_", "")} DISABLED âœ…`, true);
      } finally {
        setAllToggleButtonsEnabled(true);
      }
      return;
    }

    setAllToggleButtonsEnabled(false);
    try {
      for (const a of TOGGLES) {
        if (a !== target && toggleState[a]) {
          const rOff = await Go2Shared.httpPost(`/actions/${a}`);
          if (!rOff.ok) { Go2Shared.setStatus(`Failed disabling ${a} (HTTP ${rOff.status})`, false, `URL: ${rOff.url}\n${rOff.text}`); return; }
          toggleState[a] = false;
          setToggleBtn(a, false);
        }
      }

      const rOn = await Go2Shared.httpPost(`/actions/${target}`);
      if (!rOn.ok) { Go2Shared.setStatus(`${target} failed (HTTP ${rOn.status})`, false, `URL: ${rOn.url}\n${rOn.text}`); return; }
      toggleState[target] = true;
      setToggleBtn(target, true);
      Go2Shared.setStatus(`${target.replace("toggle_", "")} ENABLED âœ…`, true);
    } finally {
      setAllToggleButtonsEnabled(true);
    }
  }

  // ----------------------------
  // Joystick -> /teleop
  // ----------------------------
  let latest = { lx: 0, ly: 0, rx: 0 };
  const MAX_LIN = 0.6;
  const MAX_ANG = 1.2;
  const SEND_HZ = 20;
  const SEND_PERIOD_MS = Math.floor(1000 / SEND_HZ);

  function mapToCmd(lx, ly, rx) {
    const linear_x  = (-ly) * MAX_LIN;
    const linear_y  = (lx)  * MAX_LIN;
    const angular_z = (rx)  * MAX_ANG;
    return { linear_x, linear_y, angular_z };
  }

  async function sendTeleop(lx, ly, rx) {
    if (!Go2Shared.ensureLoggedIn() || !Go2Shared.state.COMMS_ENABLED) return;
    const cmd = mapToCmd(lx, ly, rx);
    const r = await Go2Shared.httpPost("/teleop", cmd);
    if (!r.ok) {
      Go2Shared.setStatus(`Teleop failed (HTTP ${r.status})`, false, `URL: ${r.url}\n${r.text}`);
    }
  }

  function makeJoystick(canvasId, onMove) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    function resize() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * devicePixelRatio);
      canvas.height = Math.floor(rect.height * devicePixelRatio);
      draw(0, 0, false);
    }

    let active = false;

    function draw(nx, ny, isActive) {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const cx = w / 2, cy = h / 2;
      const r = Math.min(w, h) * 0.35;
      const kr = Math.min(w, h) * 0.08;

      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.strokeStyle = "#ddd";
      ctx.lineWidth = 4 * devicePixelRatio;
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx - r, cy); ctx.lineTo(cx + r, cy);
      ctx.moveTo(cx, cy - r); ctx.lineTo(cx, cy + r);
      ctx.strokeStyle = "#eee";
      ctx.lineWidth = 2 * devicePixelRatio;
      ctx.stroke();

      const kx = cx + nx * r;
      const ky = cy + ny * r;
      ctx.beginPath(); ctx.arc(kx, ky, kr, 0, Math.PI * 2);
      ctx.fillStyle = isActive ? "#e9f2ff" : "#f5f5f5";
      ctx.strokeStyle = "#bbb";
      ctx.lineWidth = 3 * devicePixelRatio;
      ctx.fill(); ctx.stroke();
    }

    function pointerToNorm(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      let nx = (x - 0.5) * 2;
      let ny = (y - 0.5) * 2;
      const mag = Math.hypot(nx, ny);
      if (mag > 1) { nx /= mag; ny /= mag; }
      return { nx, ny };
    }

    canvas.addEventListener("pointerdown", (e) => {
      canvas.setPointerCapture(e.pointerId);
      active = true;
      const { nx, ny } = pointerToNorm(e);
      draw(nx, ny, true);
      onMove(nx, ny, true);
    });

    canvas.addEventListener("pointermove", (e) => {
      if (!active) return;
      const { nx, ny } = pointerToNorm(e);
      draw(nx, ny, true);
      onMove(nx, ny, true);
    });

    function release() {
      if (!active) return;
      active = false;
      draw(0, 0, false);
      onMove(0, 0, false);
    }

    canvas.addEventListener("pointerup", release);
    canvas.addEventListener("pointercancel", release);
    window.addEventListener("resize", resize);

    resize();
  }

  // Create joysticks
  makeJoystick("joyLeft", (x, y, active) => {
    latest.lx = active ? x : 0;
    latest.ly = active ? y : 0;
  });
  makeJoystick("joyRight", (x, y, active) => {
    latest.rx = active ? x : 0;
  });

  // Send loop (only sends when non-zero)
  window.setInterval(() => {
    if (!Go2Shared.ensureLoggedIn() || !Go2Shared.state.COMMS_ENABLED) return;
    const eps = 0.01;
    if (Math.abs(latest.lx) < eps && Math.abs(latest.ly) < eps && Math.abs(latest.rx) < eps) return;
    sendTeleop(latest.lx, latest.ly, latest.rx);
  }, SEND_PERIOD_MS);
</script>
</body>
</html>
