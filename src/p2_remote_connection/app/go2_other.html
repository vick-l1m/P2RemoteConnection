<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Go2 â€“ Other Controls</title>

  <link rel="stylesheet" href="/app/static/shared.css" />
  <script src="/app/static/shared.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", async () => {
      await Go2Shared.init({ defaultApi: "", showAuthButtons: true });
      setTimeout(refreshSafetyStatus, 200);

      // Enter submits move
      const moveInput = document.getElementById("moveMeters");
      moveInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitMove();
        }
      });
    });
  </script>
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="loginOverlay">
    <div class="loginCard">
      <h2>Connect to Go2</h2>
      <div class="loginForm">
        <input id="loginBaseUrl" placeholder="http://robot-ip:8000 or https://robot.domain" />
        <input id="loginToken" placeholder="Password" type="password" />

        <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:#333;">
          <input id="showPw" type="checkbox" onclick="Go2Shared.togglePasswordVisibility()" />
          Show password
        </label>

        <button id="unlockBtn" onclick="Go2Shared.login()">Unlock</button>
        <div id="loginMsg" class="loginMsg"></div>
        <div class="loginTip">Tip: This password is unique per robot.</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appRoot">
    <div class="card">
      <h1>Unitree Go2 â€“ Other Controls</h1>

      <div class="row">
        <input id="baseUrl" placeholder="http://<go2-ip>:8000" />
        <button onclick="Go2Shared.checkHealth()">Health</button>

        <button onclick="postAction('stand')">Stand</button>
        <button onclick="postAction('sit')">Sit</button>

        <button id="safetyToggleBtn" class="danger" onclick="toggleSafety()">STOP</button>
        <button onclick="toggleMoveBox()">Move X meters</button>

        <button onclick="Go2Shared.logout()">Logout</button>
      </div>

      <div id="moveBox" class="panel" style="display:none;">
        <div class="small" style="margin-bottom:8px;">
          Enter a distance (0â€“5 m) and press <b>Enter</b>.
        </div>
        <input id="moveMeters" type="number" min="-5" max="5" step="0.1" placeholder="e.g. 1.5" />
        <div class="small hint">
          Tip: Calls <span class="mono">POST /move_forward</span> â†’ <span class="mono">/move_forward_meters</span>.
        </div>
      </div>

      <div class="status">
        <div id="msg" class="small">Ready.</div>
        <div id="detail" class="mono"></div>
      </div>

      <div class="small hint">
        UI host: <span id="uiHost" class="mono"></span><br/>
        API base: <span id="apiHost" class="mono"></span>
      </div>
    </div>
  </div>

<script>
  // ----------------------------
  // STOP / RESUME
  // ----------------------------
  let stopLatched = false;
  let safetyBusy = false;

  function setSafetyButton(latched) {
    stopLatched = !!latched;
    const btn = document.getElementById("safetyToggleBtn");
    if (!btn) return;

    btn.textContent = stopLatched ? "RESUME" : "STOP";
    btn.classList.toggle("danger", !stopLatched);
    btn.disabled = safetyBusy;
  }

  async function refreshSafetyStatus() {
    if (!Go2Shared.ensureLoggedIn()) return;
    const r = await Go2Shared.httpGet("/safety/status", { bypassCommsGate: true });
    if (r.ok) {
      try {
        const data = JSON.parse(r.text);
        setSafetyButton(!!data.stop_latched);
        Go2Shared.state.COMMS_ENABLED = !stopLatched;
      } catch {}
    }
  }

  async function toggleSafety() {
    if (!Go2Shared.ensureLoggedIn() || safetyBusy) return;
    safetyBusy = true;
    setSafetyButton(stopLatched);

    try {
      if (!stopLatched) {
        const r = await Go2Shared.httpPost("/safety/stop", null, { bypassCommsGate: true });
        if (!r.ok) {
          Go2Shared.setStatus(`STOP failed (HTTP ${r.status})`, false, r.text);
          return;
        }
        Go2Shared.state.COMMS_ENABLED = false;
        Go2Shared.setStatus("STOP latched ðŸ”’", true);
      } else {
        const r = await Go2Shared.httpPost("/safety/resume", null, { bypassCommsGate: true });
        if (!r.ok) {
          Go2Shared.setStatus(`RESUME failed (HTTP ${r.status})`, false, r.text);
          return;
        }
        Go2Shared.state.COMMS_ENABLED = true;
        Go2Shared.setStatus("RESUME âœ…", true);
      }
    } finally {
      safetyBusy = false;
      await refreshSafetyStatus();
    }
  }

  // ----------------------------
  // Actions
  // ----------------------------
  async function postAction(action) {
    if (!Go2Shared.ensureLoggedIn()) return;

    if (!Go2Shared.state.COMMS_ENABLED) {
      Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME before sending commands.");
      return;
    }

    const r = await Go2Shared.httpPost(`/actions/${action}`);
    Go2Shared.setStatus(
      r.ok ? `${action} started âœ…` : `${action} failed (HTTP ${r.status})`,
      r.ok,
      r.text
    );
  }

  // ----------------------------
  // Move X meters
  // ----------------------------
  function toggleMoveBox() {
    const box = document.getElementById("moveBox");
    const open = box.style.display !== "none";
    box.style.display = open ? "none" : "block";
    if (!open) {
      const input = document.getElementById("moveMeters");
      input.value = "";
      input.focus();
    }
  }

  async function submitMove() {
    if (!Go2Shared.ensureLoggedIn()) return;

    const meters = parseFloat(document.getElementById("moveMeters").value);
    if (!Number.isFinite(meters) || Math.abs(meters) > 5 || Math.abs(meters) <= 0) {
      Go2Shared.setStatus("Invalid distance", false, "Enter a number > 0 and â‰¤ 5.");
      return;
    }

    if (!Go2Shared.state.COMMS_ENABLED) {
      Go2Shared.setStatus("STOP latched ðŸ”’", false, "Press RESUME before sending move.");
      return;
    }

    const r = await Go2Shared.httpPost("/move_forward", { meters });
    Go2Shared.setStatus(
      r.ok ? `Move sent âœ… (${meters.toFixed(2)} m)` : `Move failed (HTTP ${r.status})`,
      r.ok,
      r.text
    );

    if (r.ok) document.getElementById("moveBox").style.display = "none";
  }
</script>
</body>
</html>
