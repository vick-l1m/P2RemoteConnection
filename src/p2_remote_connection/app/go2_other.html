<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Go2 â€“ Other Controls</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 14px; background:#fafafa; }
    .card { max-width: 760px; margin: 0 auto; border: 1px solid #ddd; border-radius: 16px; padding: 14px; background:#fff; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input { padding: 10px; border-radius: 12px; border: 1px solid #ccc; flex: 1; min-width: 220px; font-size: 16px; }
    button {
      padding: 12px 12px; border-radius: 12px; border: 1px solid #ccc; background: #f7f7f7;
      font-size: 16px; cursor: pointer; min-width: 120px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .danger { background: #fff1f1; border-color: #ffb3b3; }
    .small { font-size: 13px; color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
    .status { margin-top: 12px; padding: 10px; border-radius: 12px; background: #fafafa; border: 1px solid #eee; }
    .hint { margin-top: 6px; }
    .box { margin-top: 10px; padding: 10px; border-radius: 12px; border: 1px solid #eee; background:#fafafa; }
  </style>
</head>

<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" style="
    position:fixed; inset:0; background:rgba(0,0,0,0.55);
    display:flex; align-items:center; justify-content:center; z-index:9999;
    pointer-events:auto;">
    <div style="background:white; padding:16px; border-radius:16px; width:min(420px, 92vw);">
      <h2 style="margin:0 0 10px; font-size:18px;">Connect to Go2</h2>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <input id="loginBaseUrl" placeholder="http://robot-ip:8000 or https://robot.domain"
               style="padding:10px; border-radius:12px; border:1px solid #ccc; font-size:16px;" />
        <input id="loginToken" placeholder="Password" type="password"
               style="padding:10px; border-radius:12px; border:1px solid #ccc; font-size:16px;" />
        <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:#333;">
          <input id="showPw" type="checkbox" onclick="togglePasswordVisibility()" />
          Show password
        </label>
        <button id="unlockBtn" onclick="login()" style="padding:12px; border-radius:12px; border:1px solid #ccc; background:#f7f7f7; font-size:16px;">
          Unlock
        </button>
        <div id="loginMsg" style="font-size:13px; color:#b00020;"></div>
        <div style="font-size:12px; color:#555;">Tip: This password is unique per robot.</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP (locked/blurred until login) -->
  <div id="appRoot" style="filter: blur(6px); pointer-events:none; user-select:none;">
    <div class="card">
      <h1>Unitree Go2 â€“ Other Controls</h1>

      <div class="row">
        <input id="baseUrl" placeholder="http://<go2-ip>:8000" />
        <button onclick="checkHealth()">Health</button>

        <!-- Added actions -->
        <button onclick="postAction('stand')">Stand</button>
        <button onclick="postAction('sit')">Sit</button>

        <button id="safetyToggleBtn" class="danger" onclick="toggleSafety()">STOP</button>
        <button id="moveBtn" onclick="toggleMoveBox()">Move X meters</button>

        <button onclick="logout()">Logout</button>
      </div>

      <div id="moveBox" class="box" style="display:none;">
        <div class="small" style="margin-bottom:8px;">
          Enter a distance (0â€“5 m) and press <b>Enter</b>.
        </div>
        <input id="moveMeters" type="number" min="-5" max="5" step="0.1"
               placeholder="e.g. 1.5" />
        <div class="small hint">
          Tip: This calls <span class="mono">POST /move_forward</span> which publishes to <span class="mono">/move_forward_meters</span>.
        </div>
      </div>

      <div class="status">
        <div id="msg" class="small">Ready.</div>
        <div id="detail" class="mono"></div>
      </div>

      <div class="small hint">
        UI host: <span id="uiHost" class="mono"></span><br/>
        API base: <span id="apiHost" class="mono"></span>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Authentication (same pattern as joystick page)
    // ----------------------------
    let COMMS_ENABLED = true;
    let AUTH_TOKEN = "";
    let ROBOT_BASE_URL = "";

    const LS_URL_KEY = "go2_baseUrl";
    const LS_TOKEN_KEY = "go2_token";

    function baseUrl() {
      return (ROBOT_BASE_URL || document.getElementById("baseUrl").value || "")
        .trim()
        .replace(/\/+$/, "");
    }

    function authHeaders() {
      return AUTH_TOKEN ? { "Authorization": `Bearer ${AUTH_TOKEN}` } : {};
    }

    function lockUI() {
      document.getElementById("loginOverlay").style.display = "flex";
      const root = document.getElementById("appRoot");
      root.style.filter = "blur(6px)";
      root.style.pointerEvents = "none";
      root.style.userSelect = "none";
    }

    function unlockUI() {
      document.getElementById("loginOverlay").style.display = "none";
      const root = document.getElementById("appRoot");
      root.style.filter = "none";
      root.style.pointerEvents = "auto";
      root.style.userSelect = "auto";
    }

    function saveAuth() {
      localStorage.setItem(LS_URL_KEY, ROBOT_BASE_URL);
      localStorage.setItem(LS_TOKEN_KEY, AUTH_TOKEN);
    }

    function loadAuth() {
      const u = localStorage.getItem(LS_URL_KEY) || "";
      const t = localStorage.getItem(LS_TOKEN_KEY) || "";
      return { u, t };
    }

    function clearAuth() {
      localStorage.removeItem(LS_URL_KEY);
      localStorage.removeItem(LS_TOKEN_KEY);
    }

    function togglePasswordVisibility() {
      const pw = document.getElementById("loginToken");
      const cb = document.getElementById("showPw");
      if (!pw || !cb) return;
      pw.type = cb.checked ? "text" : "password";
    }

    function ensureLoggedIn() {
      if (!ROBOT_BASE_URL || !AUTH_TOKEN) {
        const msg = document.getElementById("loginMsg");
        if (msg) msg.textContent = "Please log in.";
        lockUI();
        return false;
      }
      return true;
    }

    async function login() {
      const msg = document.getElementById("loginMsg");
      msg.textContent = "";

      const url = document.getElementById("loginBaseUrl").value.trim().replace(/\/+$/, "");
      const token = document.getElementById("loginToken").value.trim();

      if (!url || !token) {
        msg.textContent = "Please enter robot URL and password.";
        lockUI();
        return;
      }

      ROBOT_BASE_URL = url;
      AUTH_TOKEN = token;

      document.getElementById("baseUrl").value = ROBOT_BASE_URL;
      document.getElementById("apiHost").textContent = ROBOT_BASE_URL;

      try {
        const r = await httpGet("/health", { bypassCommsGate: true });
        if (!r.ok) {
          msg.textContent = (r.status === 401 || r.status === 403)
            ? "Incorrect token entered."
            : `Login failed (HTTP ${r.status})`;

          AUTH_TOKEN = "";
          ROBOT_BASE_URL = "";
          clearAuth();
          lockUI();
          return;
        }

        saveAuth();
        unlockUI();
        setStatus("Unlocked âœ…", true);
        await refreshSafetyStatus();

      } catch (e) {
        msg.textContent = "Login error: " + (e?.message || String(e));
        lockUI();
      }
    }

    function logout() {
      AUTH_TOKEN = "";
      ROBOT_BASE_URL = "";
      clearAuth();

      const t = document.getElementById("loginToken");
      if (t) t.value = "";

      const cb = document.getElementById("showPw");
      if (cb) cb.checked = false;
      if (t) t.type = "password";

      lockUI();
      setStatus("Logged out.", true);
    }

    function wireEnterToUnlock() {
      const urlEl = document.getElementById("loginBaseUrl");
      const passEl = document.getElementById("loginToken");
      const btn = document.getElementById("unlockBtn");

      const handler = (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          if (btn) btn.click();
          else login();
        }
      };

      if (urlEl)  urlEl.addEventListener("keydown", handler);
      if (passEl) passEl.addEventListener("keydown", handler);
    }
    window.addEventListener("DOMContentLoaded", wireEnterToUnlock);

    // ----------------------------
    // Networking helpers
    // ----------------------------
    function setStatus(text, ok=true, detail="") {
      const msg = document.getElementById("msg");
      const detailEl = document.getElementById("detail");
      msg.textContent = text;
      msg.style.color = ok ? "#0a7a0a" : "#b00020";
      detailEl.textContent = detail || "";
      const apiHost = document.getElementById("apiHost");
      if (apiHost) apiHost.textContent = baseUrl();
    }

    function isAlwaysAllowed(path) {
      return path === "/health" || path.startsWith("/safety/");
    }

    function commsAllowed(path, opts = {}) {
      if (opts.bypassCommsGate) return true;
      if (isAlwaysAllowed(path)) return true;
      return COMMS_ENABLED;
    }

    async function httpGet(path, opts = {}) {
      const url = baseUrl() + path;

      if (!commsAllowed(path, opts)) {
        return { ok: false, status: 0, text: "Comms disabled: press RESUME", url };
      }

      const r = await fetch(url, { headers: authHeaders() });

      if (r.status === 401 || r.status === 403) {
        AUTH_TOKEN = "";
        ROBOT_BASE_URL = "";
        clearAuth();
        lockUI();
        const m = document.getElementById("loginMsg");
        if (m) m.textContent = "Invalid token. Please log in again.";
      }

      const t = await r.text();
      return { ok: r.ok, status: r.status, text: t, url };
    }

    async function httpPost(path, json = null, opts = {}) {
      const url = baseUrl() + path;

      if (!commsAllowed(path, opts)) {
        return { ok: false, status: 0, text: "Comms disabled: press RESUME", url };
      }

      const headers = { ...authHeaders() };
      if (json !== null) headers["Content-Type"] = "application/json";

      const r = await fetch(url, {
        method: "POST",
        headers,
        body: (json !== null) ? JSON.stringify(json) : null
      });

      if (r.status === 401 || r.status === 403) {
        AUTH_TOKEN = "";
        ROBOT_BASE_URL = "";
        clearAuth();
        lockUI();
        const m = document.getElementById("loginMsg");
        if (m) m.textContent = "Invalid token. Please log in again.";
      }

      const t = await r.text();
      return { ok: r.ok, status: r.status, text: t, url };
    }

    // ----------------------------
    // Defaults + auto-login
    // ----------------------------
    function computeDefaultApi() {
      const host = window.location.hostname;
      const proto = window.location.protocol;
      return `${proto}//${host}:8000`;
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const defaultApi = computeDefaultApi();
      document.getElementById("loginBaseUrl").value = defaultApi;
      document.getElementById("baseUrl").value = defaultApi;
      document.getElementById("uiHost").textContent = location.origin;
      document.getElementById("apiHost").textContent = defaultApi;

      // Enter submits move
      const moveInput = document.getElementById("moveMeters");
      moveInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitMove();
        }
      });

      // Try remembered creds
      const { u, t } = loadAuth();
      if (u && t) {
        document.getElementById("loginBaseUrl").value = u;
        document.getElementById("loginToken").value = t;

        ROBOT_BASE_URL = u;
        AUTH_TOKEN = t;

        const r = await httpGet("/health", { bypassCommsGate: true }).catch(() => null);
        if (r && r.ok) {
          document.getElementById("baseUrl").value = ROBOT_BASE_URL;
          unlockUI();
          setStatus("Unlocked âœ… (remembered)", true);
          await refreshSafetyStatus();
          return;
        }

        AUTH_TOKEN = "";
        ROBOT_BASE_URL = "";
        clearAuth();
      }

      // Default: locked
      lockUI();
    });

    // ----------------------------
    // Health
    // ----------------------------
    async function checkHealth() {
      setStatus("Checking /health...");
      try {
        const r = await httpGet("/health", { bypassCommsGate: true });
        setStatus(
          r.ok ? "Health OK âœ…" : `Health failed (HTTP ${r.status})`,
          r.ok,
          `URL: ${r.url}\n${r.text}`
        );
      } catch (e) {
        setStatus("Health network error", false, String(e));
      }
    }

    // ----------------------------
    // Actions (Sit/Stand)
    // ----------------------------
    async function postAction(action) {
      if (!ensureLoggedIn()) return;

      if (!COMMS_ENABLED) {
        setStatus("STOP latched ðŸ”’", false, "No actions until RESUME is pressed.");
        return;
      }

      setStatus(`Sending ${action}...`);
      try {
        const r = await httpPost(`/actions/${action}`);
        setStatus(
          r.ok ? `${action} started âœ…` : `${action} failed (HTTP ${r.status})`,
          r.ok,
          `URL: ${r.url}\n${r.text}`
        );
      } catch (e) {
        setStatus(`${action} network error`, false, String(e));
      }
    }

    // ----------------------------
    // STOP/RESUME
    // ----------------------------
    let stopLatched = false;
    let safetyBusy = false;

    function setSafetyButton(latched) {
      const btn = document.getElementById("safetyToggleBtn");
      stopLatched = !!latched;

      if (stopLatched) {
        btn.textContent = "RESUME";
        btn.classList.remove("danger");
      } else {
        btn.textContent = "STOP";
        btn.classList.add("danger");
      }
      btn.disabled = safetyBusy;
    }

    async function refreshSafetyStatus() {
      if (!ensureLoggedIn()) return;

      const r = await httpGet("/safety/status", { bypassCommsGate: true });
      if (r.ok) {
        try {
          const data = JSON.parse(r.text);
          setSafetyButton(!!data.stop_latched);
        } catch (_) {}
      }
      return r;
    }

    async function toggleSafety() {
      if (!ensureLoggedIn()) return;
      if (safetyBusy) return;

      safetyBusy = true;
      setSafetyButton(stopLatched);

      try {
        if (!stopLatched) {
          const r = await httpPost("/safety/stop", null, { bypassCommsGate: true });
          if (r.ok) COMMS_ENABLED = false;
          setStatus(r.ok ? "STOP latched ðŸ”’" : `STOP failed (HTTP ${r.status})`, r.ok, `URL: ${r.url}\n${r.text}`);
        } else {
          const r = await httpPost("/safety/resume", null, { bypassCommsGate: true });
          if (r.ok) COMMS_ENABLED = true;
          setStatus(r.ok ? "RESUME âœ…" : `RESUME failed (HTTP ${r.status})`, r.ok, `URL: ${r.url}\n${r.text}`);
        }
      } catch (e) {
        setStatus("Safety network error", false, String(e));
      } finally {
        safetyBusy = false;
        await refreshSafetyStatus().catch(() => {});
      }
    }

    // ----------------------------
    // Move X meters
    // ----------------------------
    function toggleMoveBox() {
      const box = document.getElementById("moveBox");
      const open = box.style.display !== "none";
      box.style.display = open ? "none" : "block";
      if (!open) {
        const input = document.getElementById("moveMeters");
        input.value = "";
        input.focus();
      }
    }

    async function submitMove() {
      if (!ensureLoggedIn()) return;

      const metersStr = document.getElementById("moveMeters").value;
      const meters = parseFloat(metersStr);

      if (!Number.isFinite(meters) || Math.abs(meters) > 5 || Math.abs(meters) <= 0) {
        setStatus("Invalid distance", false, "Enter a number > 0 and â‰¤ 5.");
        return;
      }

      if (!COMMS_ENABLED) {
        setStatus("STOP latched ðŸ”’", false, "Press RESUME before sending move.");
        return;
      }

      setStatus(`Moving ${meters.toFixed(2)} m...`);

      try {
        const r = await httpPost("/move_forward", { meters });
        setStatus(
          r.ok ? `Move command sent âœ… (${meters.toFixed(2)} m)` : `Move failed (HTTP ${r.status})`,
          r.ok,
          `URL: ${r.url}\n${r.text}`
        );

        if (r.ok) {
          document.getElementById("moveBox").style.display = "none";
        }
      } catch (e) {
        setStatus("Move network error", false, String(e));
      }
    }
  </script>
</body>
</html>
